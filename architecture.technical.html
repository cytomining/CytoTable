<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Technical Architecture &#8212; CytoTable v0.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=99150370" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css?v=01d9ba92" />
    <script src="_static/documentation_options.js?v=2fea6348"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Data Architecture" href="architecture.data.html" />
    <link rel="prev" title="Architecture" href="architecture.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="technical-architecture">
<h1>Technical Architecture<a class="headerlink" href="#technical-architecture" title="Link to this heading">¶</a></h1>
<p>Documentation covering technical architecture for CytoTable.</p>
<section id="workflows">
<h2>Workflows<a class="headerlink" href="#workflows" title="Link to this heading">¶</a></h2>
<p>CytoTable uses <a class="reference external" href="https://parsl.readthedocs.io/">Parsl</a> to execute collections of tasks as <a class="reference external" href="https://parsl.readthedocs.io/en/stable/quickstart.html#application-types"><code class="docutils literal notranslate"><span class="pre">python_app</span></code>’s</a>.
In Parsl, work may be isolated using Python functions decorated with the <code class="docutils literal notranslate"><span class="pre">&#64;python_app</span></code> decorator.
<a class="reference external" href="https://parsl.readthedocs.io/en/stable/1-parsl-introduction.html#Dynamic-workflows-with-apps-that-generate-other-apps"><code class="docutils literal notranslate"><span class="pre">join_app</span></code>’s</a> are collections of one or more other apps and are decorated using the <code class="docutils literal notranslate"><span class="pre">&#64;join_app</span></code> decorator.
See the following documentation for more information on how apps may be used within Parsl: <a class="reference external" href="https://parsl.readthedocs.io/en/stable/userguide/apps.html">Parsl: Apps</a></p>
<section id="workflow-execution">
<h3>Workflow Execution<a class="headerlink" href="#workflow-execution" title="Link to this heading">¶</a></h3>
<p>Workflow tasks within CytoTable are executed using <a class="reference external" href="https://parsl.readthedocs.io/en/stable/userguide/execution.html">Parsl Executors</a>.
Parsl Executors for CytoTable may be configured through <a class="reference external" href="https://parsl.readthedocs.io/en/stable/userguide/execution.html#configuration">Parsl <code class="docutils literal notranslate"><span class="pre">Config</span></code>’s</a> .</p>
<p>For example, you may use the following: <code class="code docutils literal notranslate"><span class="pre">convert(...,</span> <span class="pre">parsl_config=parsl.Config())</span></code> (<a class="reference internal" href="python-api.html#cytotable.convert.convert" title="cytotable.convert.convert"><code class="xref py py-mod docutils literal notranslate"><span class="pre">convert()</span></code></a>)</p>
<p>CytoTable is implemented by default with Parsl’s <a class="reference external" href="https://parsl.readthedocs.io/en/stable/stubs/parsl.executors.HighThroughputExecutor.html#parsl.executors.HighThroughputExecutor"><code class="docutils literal notranslate"><span class="pre">HighThroughputExecutor</span></code></a>, a multiprocess executor (please see <a class="reference external" href="https://parsl.readthedocs.io/en/stable/userguide/performance.html">Parsl’s scalability documentation</a> for more information).</p>
<p>Please note: use of Parsl’s <a class="reference external" href="https://parsl.readthedocs.io/en/stable/stubs/parsl.executors.ThreadPoolExecutor.html"><code class="docutils literal notranslate"><span class="pre">ThreadPoolExecutor</span></code></a> may result in unfreed memory within certain systems because of Apache Arrow’s memory allocators.
Unfreed memory can eventually result in a lack of available memory through single-process use.
When using ThreadPoolExecutor we suggest using a Linux system, leveraging the <code class="docutils literal notranslate"><span class="pre">malloc</span></code>/system memory allocator with Arrow (e.g. <code class="docutils literal notranslate"><span class="pre">export</span> <span class="pre">ARROW_DEFAULT_MEMORY_POOL=&quot;system&quot;</span></code>), and/or forking subprocedures for best results when it comes to freeing memory for these usecases.
This note does not apply to the <code class="docutils literal notranslate"><span class="pre">HighThroughputExecutor</span></code>.</p>
</section>
</section>
<section id="data-technologies">
<h2>Data Technologies<a class="headerlink" href="#data-technologies" title="Link to this heading">¶</a></h2>
<section id="data-paths">
<h3>Data Paths<a class="headerlink" href="#data-paths" title="Link to this heading">¶</a></h3>
<p>Data source paths handled by CytoTable may be local or cloud-based paths.
Local data paths are handled using <a class="reference external" href="https://docs.python.org/3/library/pathlib.html">Python’s Pathlib</a> module.
Cloud-based data paths are managed by <a class="reference external" href="https://cloudpathlib.drivendata.org/~latest/">cloudpathlib</a>.
Reference the following page for how cloudpathlib client arguments may be used: <a class="reference internal" href="overview.html#data-source-locations"><span class="std std-ref">Overview: Data Source Locations</span></a></p>
<section id="data-paths-cloud-based-sqlite">
<h4>Data Paths - Cloud-based SQLite<a class="headerlink" href="#data-paths-cloud-based-sqlite" title="Link to this heading">¶</a></h4>
<p>SQLite data stored in cloud-based paths are downloaded locally using cloudpathlib’s <a class="reference external" href="https://cloudpathlib.drivendata.org/stable/caching/">caching capabilities</a> to perform SQL queries.
Using data in this way may require the use of an additional parameter for the cloud storage provider to set the cache directory explicitly to avoid storage limitations (some temporary directories are constrained to system memory, etc).</p>
<p>For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">cytotable</span>

<span class="c1"># Convert CellProfiler SQLite to parquet</span>
<span class="n">cytotable</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span>
    <span class="n">source_path</span><span class="o">=</span><span class="s2">&quot;s3://bucket-name/single-cells.sqlite&quot;</span><span class="p">,</span>
    <span class="n">dest_path</span><span class="o">=</span><span class="s2">&quot;test.parquet&quot;</span><span class="p">,</span>
    <span class="n">dest_datatype</span><span class="o">=</span><span class="s2">&quot;parquet&quot;</span><span class="p">,</span>
    <span class="c1"># set the local cache dir to `./tmpdata`</span>
    <span class="c1"># this will get passed to cloudpathlib&#39;s client</span>
    <span class="n">local_cache_dir</span><span class="o">=</span><span class="s2">&quot;./tmpdata&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="in-process-data-format">
<h3>In-process Data Format<a class="headerlink" href="#in-process-data-format" title="Link to this heading">¶</a></h3>
<p>In addition to using Python native data types, we also accomplish internal data management for CytoTable using <a class="reference external" href="https://arrow.apache.org/docs/python/generated/pyarrow.Table.html">PyArrow (Apache Arrow) Tables</a>.
Using Arrow-compatible formats is intended to assist cross-platform utility, encourage high-performance, and enable advanced data integration with non-Python tools.</p>
<section id="arrow-memory-allocator-selection">
<h4>Arrow Memory Allocator Selection<a class="headerlink" href="#arrow-memory-allocator-selection" title="Link to this heading">¶</a></h4>
<p>PyArrow may select to use <a class="reference external" href="https://en.wikipedia.org/wiki/C_dynamic_memory_allocation"><code class="docutils literal notranslate"><span class="pre">malloc</span></code></a>, <a class="reference external" href="https://github.com/jemalloc/jemalloc"><code class="docutils literal notranslate"><span class="pre">jemalloc</span></code></a>, or <a class="reference external" href="https://github.com/microsoft/mimalloc"><code class="docutils literal notranslate"><span class="pre">mimalloc</span></code></a> depending on the operating system and allocator availability.
This memory allocator selection may also be overridden by a developer implementing CytoTable to help with performance aspects related to user environments.
PyArrow inherits environment configuration from the Arrow C++ implementation (<a class="reference external" href="https://arrow.apache.org/docs/python/env_vars.html">see note on this page</a>).
Use the <a class="reference external" href="https://arrow.apache.org/docs/cpp/env_vars.html#envvar-ARROW_DEFAULT_MEMORY_POOL"><code class="docutils literal notranslate"><span class="pre">ARROW_DEFAULT_MEMORY_POOL</span></code> environment variable</a> to statically define which memory allocator will be used when implementing CytoTable.</p>
</section>
<section id="arrow-memory-mapping-selection">
<h4>Arrow Memory Mapping Selection<a class="headerlink" href="#arrow-memory-mapping-selection" title="Link to this heading">¶</a></h4>
<p>PyArrow includes functionality which enables <a class="reference external" href="https://en.wikipedia.org/wiki/Memory-mapped_file">memory mapped</a> parquet file reads for performance benefits (<a class="reference external" href="https://arrow.apache.org/docs/python/generated/pyarrow.parquet.read_table.html">see <code class="docutils literal notranslate"><span class="pre">memory_map</span></code> parameter</a>).
This functionality is enabled by default in CytoTable.
You may disable this functionality by setting environment variable <code class="docutils literal notranslate"><span class="pre">CYTOTABLE_ARROW_USE_MEMORY_MAPPING</span></code> to <code class="docutils literal notranslate"><span class="pre">0</span></code> (for example: <code class="docutils literal notranslate"><span class="pre">export</span> <span class="pre">CYTOTABLE_ARROW_USE_MEMORY_MAPPING=0</span></code>).</p>
</section>
</section>
<section id="sql-based-data-management">
<h3>SQL-based Data Management<a class="headerlink" href="#sql-based-data-management" title="Link to this heading">¶</a></h3>
<p>We use the <a class="reference external" href="https://duckdb.org/docs/api/python/overview">DuckDB Python API client</a> in some areas to interface with <a class="reference external" href="https://en.wikipedia.org/wiki/SQL">SQL</a> (for example, SQLite databases) and other data formats.
We use DuckDB SQL statements to organize joined datasets or tables as Arrow format results.</p>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">CytoTable</a></h1>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=cytomining&repo=CytoTable&type=star&count=false&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="presentations.html">Presentations</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="code_of_conduct.html">Code of Conduct</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="architecture.html">Architecture</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Technical Architecture</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#workflows">Workflows</a></li>
<li class="toctree-l3"><a class="reference internal" href="#data-technologies">Data Technologies</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="architecture.data.html">Data Architecture</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="python-api.html">Python API</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
  <li><a href="architecture.html">Architecture</a><ul>
      <li>Previous: <a href="architecture.html" title="previous chapter">Architecture</a></li>
      <li>Next: <a href="architecture.data.html" title="next chapter">Data Architecture</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2022, Cytomining Community.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.1.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
      |
      <a href="_sources/architecture.technical.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>