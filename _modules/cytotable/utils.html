<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>cytotable.utils &#8212; CytoTable v0.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=99150370" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=01d9ba92" />
    <script src="../../_static/documentation_options.js?v=2fea6348"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/mermaid@11.12.1/dist/mermaid.esm.min.mjs"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.2.0/dist/mermaid-layout-elk.esm.min.mjs"></script>
    <script type="module">import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.12.1/dist/mermaid.esm.min.mjs";import elkLayouts from "https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.2.0/dist/mermaid-layout-elk.esm.min.mjs";mermaid.registerLayoutLoaders(elkLayouts);mermaid.initialize({startOnLoad:false});</script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
    <script type="module">import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.12.1/dist/mermaid.esm.min.mjs";

const defaultStyle = document.createElement('style');
defaultStyle.textContent = `pre.mermaid {
    /* Same as .mermaid-container > pre */
    display: block;
    width: 100%;
}

pre.mermaid > svg {
    /* Same as .mermaid-container > pre > svg */
    height: 500px;
    width: 100%;
    max-width: 100% !important;
}
`;
document.head.appendChild(defaultStyle);

const fullscreenStyle = document.createElement('style');
fullscreenStyle.textContent = `.mermaid-container {
    display: flex;
    flex-direction: row;
    width: 100%;
}

.mermaid-container > pre {
    display: block;
    width: 100%;
}

.mermaid-container > pre > svg {
    height: 500px;
    width: 100%;
    max-width: 100% !important;
}

.mermaid-fullscreen-btn {
    width: 28px;
    height: 28px;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0, 0, 0, 0.3);
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    font-size: 14px;
    line-height: 1;
    padding: 0;
    color: #333;
}

.mermaid-fullscreen-btn:hover {
    opacity: 100% !important;
    background: rgba(255, 255, 255, 1);
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
    transform: scale(1.1);
}

.mermaid-fullscreen-btn.dark-theme {
    background: rgba(50, 50, 50, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: #e0e0e0;
}

.mermaid-fullscreen-btn.dark-theme:hover {
    background: rgba(60, 60, 60, 1);
    box-shadow: 0 3px 10px rgba(255, 255, 255, 0.2);
}

.mermaid-fullscreen-modal {
    display: none;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 95vw;
    height: 100vh;
    background: rgba(255, 255, 255, 0.98);
    z-index: 9999;
    padding: 20px;
    overflow: auto;
}

.mermaid-fullscreen-modal.dark-theme {
    background: rgba(0, 0, 0, 0.98);
}

.mermaid-fullscreen-modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
}

.mermaid-container-fullscreen {
    position: relative;
    width: 95vw;
    height: 90vh;
    max-width: 95vw;
    max-height: 90vh;
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    overflow: auto;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mermaid-container-fullscreen.dark-theme {
    background: #1a1a1a;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
}

.mermaid-container-fullscreen pre.mermaid {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mermaid-container-fullscreen .mermaid svg {
    height: 100% !important;
    width: 100% !important;
    cursor: grab;
}

.mermaid-fullscreen-close {
    position: fixed !important;
    top: 20px !important;
    right: 20px !important;
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0, 0, 0, 0.2);
    border-radius: 50%;
    cursor: pointer;
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    transition: all 0.2s;
    font-size: 24px;
    line-height: 1;
    color: #333;
}

.mermaid-fullscreen-close:hover {
    background: white;
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
    transform: scale(1.1);
}

.mermaid-fullscreen-close.dark-theme {
    background: rgba(50, 50, 50, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #e0e0e0;
}

.mermaid-fullscreen-close.dark-theme:hover {
    background: rgba(60, 60, 60, 1);
    box-shadow: 0 6px 16px rgba(255, 255, 255, 0.2);
}

.mermaid-fullscreen-modal .mermaid-fullscreen-btn {
    display: none !important;
}`;
document.head.appendChild(fullscreenStyle);

// Detect if page has dark background
const isDarkTheme = () => {
    const bgColor = window.getComputedStyle(document.body).backgroundColor;
    const match = bgColor.match(/rgb\((\d+),\s*(\d+),\s*(\d+)/);
    if (match) {
        const r = parseInt(match[1]);
        const g = parseInt(match[2]);
        const b = parseInt(match[3]);
        const brightness = (r * 299 + g * 587 + b * 114) / 1000;
        return brightness < 128;
    }
    return false;
};

const load = async () => {
    await mermaid.run();

    const all_mermaids = document.querySelectorAll(".mermaid");
    const mermaids_processed = document.querySelectorAll(".mermaid[data-processed='true']");

    if ("False" === "True") {
        const mermaids_to_add_zoom = -1 === -1 ? all_mermaids.length : -1;
        if(mermaids_to_add_zoom > 0) {
            var svgs = d3.selectAll("");
            if(all_mermaids.length !== mermaids_processed.length) {
                setTimeout(load, 200);
                return;
            } else if(svgs.size() !== mermaids_to_add_zoom) {
                setTimeout(load, 200);
                return;
            } else {
                svgs.each(function() {
                    var svg = d3.select(this);
                    svg.html("<g class='wrapper'>" + svg.html() + "</g>");
                    var inner = svg.select("g");
                    var zoom = d3.zoom().on("zoom", function(event) {
                        inner.attr("transform", event.transform);
                    });
                    svg.call(zoom);
                });
            }
        }
    } else if(all_mermaids.length !== mermaids_processed.length) {
        // Wait for mermaid to process all diagrams
        setTimeout(load, 200);
        return;
    }

    const darkTheme = isDarkTheme();

    // Stop here if not adding fullscreen capability
    if ("True" !== "True") return;

    const modal = document.createElement('div');
    modal.className = 'mermaid-fullscreen-modal' + (darkTheme ? ' dark-theme' : '');
    modal.setAttribute('role', 'dialog');
    modal.setAttribute('aria-modal', 'true');
    modal.setAttribute('aria-label', 'Fullscreen diagram viewer');
    modal.innerHTML = `
        <button class="mermaid-fullscreen-close${darkTheme ? ' dark-theme' : ''}" aria-label="Close fullscreen">✕</button>
        <div class="mermaid-container-fullscreen${darkTheme ? ' dark-theme' : ''}"></div>
    `;
    document.body.appendChild(modal);

    const modalContent = modal.querySelector('.mermaid-container-fullscreen');
    const closeBtn = modal.querySelector('.mermaid-fullscreen-close');

    let previousScrollOffset = [window.scrollX, window.scrollY];

    const closeModal = () => {
        modal.classList.remove('active');
        modalContent.innerHTML = '';
        document.body.style.overflow = ''
        window.scrollTo({left: previousScrollOffset[0], top: previousScrollOffset[1], behavior: 'instant'});
    };

    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
            closeModal();
        }
    });

    const allButtons = [];

    document.querySelectorAll('.mermaid').forEach((mermaidDiv) => {
        if (mermaidDiv.parentNode.classList.contains('mermaid-container') ||
            mermaidDiv.closest('.mermaid-fullscreen-modal')) {
            return;
        }

        const container = document.createElement('div');
        container.className = 'mermaid-container';
        mermaidDiv.parentNode.insertBefore(container, mermaidDiv);
        container.appendChild(mermaidDiv);

        const fullscreenBtn = document.createElement('button');
        fullscreenBtn.className = 'mermaid-fullscreen-btn' + (darkTheme ? ' dark-theme' : '');
        fullscreenBtn.setAttribute('aria-label', 'View diagram in fullscreen');
        fullscreenBtn.textContent = '⛶';
        fullscreenBtn.style.opacity = '50%';

        // Calculate dynamic position based on diagram's margin and padding
        const diagramStyle = window.getComputedStyle(mermaidDiv);
        const marginTop = parseFloat(diagramStyle.marginTop) || 0;
        const marginRight = parseFloat(diagramStyle.marginRight) || 0;
        const paddingTop = parseFloat(diagramStyle.paddingTop) || 0;
        const paddingRight = parseFloat(diagramStyle.paddingRight) || 0;
        fullscreenBtn.style.top = `${marginTop + paddingTop + 4}px`;
        fullscreenBtn.style.right = `${marginRight + paddingRight + 4}px`;

        fullscreenBtn.addEventListener('click', () => {
            previousScrollOffset = [window.scroll, window.scrollY];
            const clone = mermaidDiv.cloneNode(true);
            modalContent.innerHTML = '';
            modalContent.appendChild(clone);

            const svg = clone.querySelector('svg');
            if (svg) {
                svg.removeAttribute('width');
                svg.removeAttribute('height');
                svg.style.width = '100%';
                svg.style.height = 'auto';
                svg.style.maxWidth = '100%';
                svg.style.sdisplay = 'block';

                if ("False" === "True") {
                    setTimeout(() => {
                        const g = svg.querySelector('g');
                        if (g) {
                            var svgD3 = d3.select(svg);
                            svgD3.html("<g class='wrapper'>" + svgD3.html() + "</g>");
                            var inner = svgD3.select("g");
                            var zoom = d3.zoom().on("zoom", function(event) {
                                inner.attr("transform", event.transform);
                            });
                            svgD3.call(zoom);
                        }
                    }, 100);
                }
            }

            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        });

        container.appendChild(fullscreenBtn);
        allButtons.push(fullscreenBtn);
    });

    // Update theme classes when theme changes
    const updateTheme = () => {
        const dark = isDarkTheme();
        allButtons.forEach(btn => {
            if (dark) {
                btn.classList.add('dark-theme');
            } else {
                btn.classList.remove('dark-theme');
            }
        });
        if (dark) {
            modal.classList.add('dark-theme');
            modalContent.classList.add('dark-theme');
            closeBtn.classList.add('dark-theme');
        } else {
            modal.classList.remove('dark-theme');
            modalContent.classList.remove('dark-theme');
            closeBtn.classList.remove('dark-theme');
        }
    };

    // Watch for theme changes
    const observer = new MutationObserver(updateTheme);
    observer.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['class', 'style', 'data-theme']
    });
    observer.observe(document.body, {
        attributes: true,
        attributeFilter: ['class', 'style']
    });
};

window.addEventListener("load", load);
</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for cytotable.utils</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Utility functions for CytoTable</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span><span class="p">,</span> <span class="n">PurePosixPath</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterator</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">cast</span>

<span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">import</span> <span class="nn">duckdb</span>
<span class="kn">import</span> <span class="nn">parsl</span>
<span class="kn">import</span> <span class="nn">pyarrow</span> <span class="k">as</span> <span class="nn">pa</span>
<span class="kn">from</span> <span class="nn">botocore</span> <span class="kn">import</span> <span class="n">UNSIGNED</span>
<span class="kn">from</span> <span class="nn">botocore.config</span> <span class="kn">import</span> <span class="n">Config</span> <span class="k">as</span> <span class="n">BotoConfig</span>
<span class="kn">from</span> <span class="nn">cloudpathlib</span> <span class="kn">import</span> <span class="n">AnyPath</span><span class="p">,</span> <span class="n">CloudPath</span><span class="p">,</span> <span class="n">S3Client</span><span class="p">,</span> <span class="n">S3Path</span>
<span class="kn">from</span> <span class="nn">cloudpathlib.exceptions</span> <span class="kn">import</span> <span class="n">InvalidPrefixError</span>
<span class="kn">from</span> <span class="nn">parsl.app.app</span> <span class="kn">import</span> <span class="n">AppBase</span>
<span class="kn">from</span> <span class="nn">parsl.config</span> <span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span> <span class="nn">parsl.errors</span> <span class="kn">import</span> <span class="n">NoDataFlowKernelError</span>
<span class="kn">from</span> <span class="nn">parsl.executors</span> <span class="kn">import</span> <span class="n">HighThroughputExecutor</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># reference the original init</span>
<span class="n">original_init</span> <span class="o">=</span> <span class="n">AppBase</span><span class="o">.</span><span class="fm">__init__</span>


<div class="viewcode-block" id="Parsl_AppBase_init_for_docs">
<a class="viewcode-back" href="../../python-api.html#cytotable.utils.Parsl_AppBase_init_for_docs">[docs]</a>
<span class="k">def</span> <span class="nf">Parsl_AppBase_init_for_docs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A function to extend Parsl.app.app.AppBase with</span>
<span class="sd">    docstring from decorated functions rather than</span>
<span class="sd">    the decorators from Parsl. Used for</span>
<span class="sd">    Sphinx documentation purposes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">original_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="c1"># add function doc as the app doc</span>
    <span class="bp">self</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span></div>



<span class="c1"># set the AppBase to the new init for the docstring.</span>
<span class="n">AppBase</span><span class="o">.</span><span class="fm">__init__</span> <span class="o">=</span> <span class="n">Parsl_AppBase_init_for_docs</span>


<div class="viewcode-block" id="_parsl_loaded">
<a class="viewcode-back" href="../../python-api.html#cytotable.utils._parsl_loaded">[docs]</a>
<span class="k">def</span> <span class="nf">_parsl_loaded</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks whether Parsl configuration has already been loaded.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># try to reference Parsl dataflowkernel</span>
        <span class="n">parsl</span><span class="o">.</span><span class="n">dfk</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">NoDataFlowKernelError</span><span class="p">:</span>
        <span class="c1"># if we detect a Parsl NoDataFlowKernelError</span>
        <span class="c1"># return false to indicate parsl config has not yet been loaded.</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># otherwise we indicate parsl config has already been loaded</span>
    <span class="k">return</span> <span class="kc">True</span></div>



<div class="viewcode-block" id="_default_parsl_config">
<a class="viewcode-back" href="../../python-api.html#cytotable.utils._default_parsl_config">[docs]</a>
<span class="k">def</span> <span class="nf">_default_parsl_config</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a default Parsl configuration for use with CytoTable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Config</span><span class="p">(</span>
        <span class="n">executors</span><span class="o">=</span><span class="p">[</span>
            <span class="n">HighThroughputExecutor</span><span class="p">(</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;htex_default_for_cytotable&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">]</span>
    <span class="p">)</span></div>



<span class="c1"># custom sort for resulting columns</span>
<div class="viewcode-block" id="_column_sort">
<a class="viewcode-back" href="../../python-api.html#cytotable.utils._column_sort">[docs]</a>
<span class="k">def</span> <span class="nf">_column_sort</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A custom sort for column values as a list.</span>
<span class="sd">    To be used with sorted and Pyarrow tables.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># lowercase str which will be used for comparisons</span>
    <span class="c1"># to avoid any capitalization challenges</span>
    <span class="n">value_lower</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="c1"># first sorted values (by list index)</span>
    <span class="n">sort_first</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;tablenumber&quot;</span><span class="p">,</span>
        <span class="s2">&quot;metadata_tablenumber&quot;</span><span class="p">,</span>
        <span class="s2">&quot;imagenumber&quot;</span><span class="p">,</span>
        <span class="s2">&quot;metadata_imagenumber&quot;</span><span class="p">,</span>
        <span class="s2">&quot;objectnumber&quot;</span><span class="p">,</span>
        <span class="s2">&quot;object_number&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="c1"># middle sort value</span>
    <span class="n">sort_middle</span> <span class="o">=</span> <span class="s2">&quot;metadata&quot;</span>

    <span class="c1"># sorted last (by list order enumeration)</span>
    <span class="n">sort_later</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;image&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cytoplasm&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cells&quot;</span><span class="p">,</span>
        <span class="s2">&quot;nuclei&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="c1"># if value is in the sort_first list</span>
    <span class="c1"># return the index from that list</span>
    <span class="k">if</span> <span class="n">value_lower</span> <span class="ow">in</span> <span class="n">sort_first</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sort_first</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">value_lower</span><span class="p">)</span>

    <span class="c1"># if sort_middle is anywhere in value return</span>
    <span class="c1"># next index value after sort_first values</span>
    <span class="k">if</span> <span class="n">sort_middle</span> <span class="ow">in</span> <span class="n">value_lower</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">sort_first</span><span class="p">)</span>

    <span class="c1"># if any sort_later are found as the first part of value</span>
    <span class="c1"># return enumerated index of sort_later value (starting from</span>
    <span class="c1"># relative len based on the above conditionals and lists)</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">value_lower</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">sort_later</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">_k</span><span class="p">,</span> <span class="n">_v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sort_later</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">sort_first</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">value_lower</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">_v</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">_k</span>

    <span class="c1"># else we return the total length of all sort values</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">sort_first</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">sort_later</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span></div>



<div class="viewcode-block" id="_duckdb_reader">
<a class="viewcode-back" href="../../python-api.html#cytotable.utils._duckdb_reader">[docs]</a>
<span class="k">def</span> <span class="nf">_duckdb_reader</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">DuckDBPyConnection</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a DuckDB connection with the</span>
<span class="sd">    sqlite_scanner installed and loaded.</span>

<span class="sd">    Note: using this function assumes implementation will</span>
<span class="sd">    close the subsequently created DuckDB connection using</span>
<span class="sd">    `_duckdb_reader().close()` or using a context manager,</span>
<span class="sd">    for ex., using: `with _duckdb_reader() as ddb_reader:`</span>

<span class="sd">    Returns:</span>
<span class="sd">        duckdb.DuckDBPyConnection</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">duckdb</span>

    <span class="kn">from</span> <span class="nn">cytotable.constants</span> <span class="kn">import</span> <span class="n">MAX_THREADS</span>

    <span class="k">return</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="c1"># note: we use an f-string here to</span>
        <span class="c1"># dynamically configure threads as appropriate</span>
        <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        /* Install and load sqlite plugin for duckdb */</span>
<span class="s2">        INSTALL sqlite_scanner;</span>
<span class="s2">        LOAD sqlite_scanner;</span>

<span class="s2">        /* Install httpfs plugin to avoid error</span>
<span class="s2">        https://github.com/duckdb/duckdb/issues/3243 */</span>
<span class="s2">        INSTALL httpfs;</span>

<span class="s2">        /*</span>
<span class="s2">        Set threads available to duckdb</span>
<span class="s2">        See the following for more information:</span>
<span class="s2">        https://duckdb.org/docs/sql/pragmas#memory_limit-threads</span>
<span class="s2">        */</span>
<span class="s2">        PRAGMA threads=</span><span class="si">{</span><span class="n">MAX_THREADS</span><span class="si">}</span><span class="s2">;</span>

<span class="s2">        /*</span>
<span class="s2">        Allow unordered results for performance increase possibilities</span>
<span class="s2">        See the following for more information:</span>
<span class="s2">        https://duckdb.org/docs/sql/configuration#configuration-reference</span>
<span class="s2">        */</span>
<span class="s2">        PRAGMA preserve_insertion_order=FALSE;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="_sqlite_mixed_type_query_to_parquet">
<a class="viewcode-back" href="../../python-api.html#cytotable.utils._sqlite_mixed_type_query_to_parquet">[docs]</a>
<span class="k">def</span> <span class="nf">_sqlite_mixed_type_query_to_parquet</span><span class="p">(</span>
    <span class="n">source_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">page_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">pageset</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span>
    <span class="n">sort_output</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">tablenumber</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs SQLite table data extraction where one or many</span>
<span class="sd">    columns include data values of potentially mismatched type</span>
<span class="sd">    such that the data may be exported to Arrow for later use.</span>

<span class="sd">    Args:</span>
<span class="sd">        source_path: str:</span>
<span class="sd">            A str which is a path to a SQLite database file.</span>
<span class="sd">        table_name: str:</span>
<span class="sd">            The name of the table being queried.</span>
<span class="sd">        page_key: str:</span>
<span class="sd">            The column name to be used to identify pagination chunks.</span>
<span class="sd">        pageset: Tuple[Union[int, float], Union[int, float]]:</span>
<span class="sd">            The range for values used for paginating data from source.</span>
<span class="sd">        sort_output: bool</span>
<span class="sd">            Specifies whether to sort cytotable output or not.</span>
<span class="sd">        add_cytotable_meta: bool, default=False:</span>
<span class="sd">            Whether to add CytoTable metadata fields or not</span>
<span class="sd">        tablenumber: Optional[int], default=None:</span>
<span class="sd">            An optional table number to append to the results.</span>
<span class="sd">            Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pyarrow.Table:</span>
<span class="sd">           The resulting arrow table for the data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">sqlite3</span>

    <span class="kn">import</span> <span class="nn">pyarrow</span> <span class="k">as</span> <span class="nn">pa</span>

    <span class="kn">from</span> <span class="nn">cytotable.constants</span> <span class="kn">import</span> <span class="n">SQLITE_AFFINITY_DATA_TYPE_SYNONYMS</span>
    <span class="kn">from</span> <span class="nn">cytotable.exceptions</span> <span class="kn">import</span> <span class="n">DatatypeException</span>

    <span class="c1"># open sqlite3 connection</span>
    <span class="k">with</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">source_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="c1"># Gather table column details including datatype.</span>
        <span class="c1"># Note: uses SQLite pragma for table information.</span>
        <span class="c1"># See the following for more information:</span>
        <span class="c1"># https://sqlite.org/pragma.html#pragma_table_info</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            SELECT :table_name as table_name,</span>
<span class="sd">                    name as column_name,</span>
<span class="sd">                    type as column_type</span>
<span class="sd">            FROM pragma_table_info(:table_name)</span>
<span class="sd">            /* explicit column ordering by &#39;cid&#39; */</span>
<span class="sd">            ORDER BY cid ASC;</span>
<span class="sd">            &quot;&quot;&quot;</span><span class="p">,</span>
            <span class="p">{</span><span class="s2">&quot;table_name&quot;</span><span class="p">:</span> <span class="n">table_name</span><span class="p">},</span>
        <span class="p">)</span>

        <span class="c1"># gather column metadata details as list of dictionaries</span>
        <span class="n">column_info</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="n">desc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">desc</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">description</span><span class="p">],</span> <span class="n">row</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="p">]</span>

        <span class="k">def</span> <span class="nf">_sqlite_affinity_data_type_lookup</span><span class="p">(</span><span class="n">col_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="c1"># seek the translated type from SQLITE_AFFINITY_DATA_TYPE_SYNONYMS</span>
            <span class="n">translated_type</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">key</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">SQLITE_AFFINITY_DATA_TYPE_SYNONYMS</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">col_type</span> <span class="ow">in</span> <span class="n">values</span>
            <span class="p">]</span>

            <span class="c1"># if we&#39;re unable to find a synonym for the type, raise an error</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">translated_type</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">DatatypeException</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unable to find SQLite data type synonym for </span><span class="si">{</span><span class="n">col_type</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>

            <span class="c1"># return the translated type for use in SQLite</span>
            <span class="k">return</span> <span class="n">translated_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># build tablenumber segment addition (if necessary)</span>
        <span class="n">tablenumber_sql</span> <span class="o">=</span> <span class="p">(</span>
            <span class="c1"># to become tablenumber in sql select later with integer</span>
            <span class="sa">f</span><span class="s2">&quot;CAST(</span><span class="si">{</span><span class="n">tablenumber</span><span class="si">}</span><span class="s2"> AS INTEGER) as TableNumber, &quot;</span>
            <span class="k">if</span> <span class="n">tablenumber</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="c1"># if we don&#39;t have a tablenumber value, don&#39;t introduce the column</span>
            <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="p">)</span>

        <span class="c1"># create cases for mixed-type handling in each column discovered above</span>
        <span class="n">query_parts</span> <span class="o">=</span> <span class="n">tablenumber_sql</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            CASE</span>
<span class="s2">                /* when the storage class type doesn&#39;t match the column, return nulltype */</span>
<span class="s2">                WHEN typeof(</span><span class="si">{</span><span class="n">col</span><span class="p">[</span><span class="s1">&#39;column_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">) !=</span>
<span class="s2">                &#39;</span><span class="si">{</span><span class="n">_sqlite_affinity_data_type_lookup</span><span class="p">(</span><span class="n">col</span><span class="p">[</span><span class="s1">&#39;column_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span><span class="si">}</span><span class="s2">&#39; THEN NULL</span>
<span class="s2">                /* else, return the normal value */</span>
<span class="s2">                ELSE </span><span class="si">{</span><span class="n">col</span><span class="p">[</span><span class="s1">&#39;column_name&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">            END AS </span><span class="si">{</span><span class="n">col</span><span class="p">[</span><span class="s1">&#39;column_name&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">            &quot;&quot;&quot;</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">column_info</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># perform the select using the cases built above and using chunksize + offset</span>
        <span class="n">sql_stmt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT</span>
<span class="s2">                </span><span class="si">{</span><span class="n">query_parts</span><span class="si">}</span>
<span class="s2">            FROM </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span>
<span class="s2">            WHERE </span><span class="si">{</span><span class="n">page_key</span><span class="si">}</span><span class="s2"> BETWEEN </span><span class="si">{</span><span class="n">pageset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> AND </span><span class="si">{</span><span class="n">pageset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span>
<span class="s2">            </span><span class="si">{</span><span class="s2">&quot;ORDER BY &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">page_key</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">sort_output</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="si">}</span><span class="s2">;</span>
<span class="s2">            &quot;&quot;&quot;</span>

        <span class="c1"># execute the sql stmt</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql_stmt</span><span class="p">)</span>
        <span class="c1"># collect the results and include the column name with values</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="n">desc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">desc</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">description</span><span class="p">],</span> <span class="n">row</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="p">]</span>

        <span class="c1"># close the sqlite3 cursor</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># close the sqlite3 connection</span>
    <span class="c1"># note: context manager does not automatically close the connection</span>
    <span class="c1"># as per notes found under:</span>
    <span class="c1"># https://docs.python.org/3/library/sqlite3.html#sqlite3-connection-context-manager</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># return arrow table with results</span>
    <span class="k">return</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="o">.</span><span class="n">from_pylist</span><span class="p">(</span><span class="n">results</span><span class="p">)</span></div>



<div class="viewcode-block" id="_cache_cloudpath_to_local">
<a class="viewcode-back" href="../../python-api.html#cytotable.utils._cache_cloudpath_to_local">[docs]</a>
<span class="k">def</span> <span class="nf">_cache_cloudpath_to_local</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">AnyPath</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes a cloudpath and uses cache to convert to a local copy</span>
<span class="sd">    for use in scenarios where remote work is not possible (sqlite).</span>

<span class="sd">    Args:</span>
<span class="sd">        path: Union[str, AnyPath]</span>
<span class="sd">            A filepath which will be checked and potentially</span>
<span class="sd">            converted to a local filepath.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pathlib.Path</span>
<span class="sd">            A local pathlib.Path to cached version of cloudpath file.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># check that the path is a file (caching won&#39;t work with a dir)</span>
    <span class="c1"># and check that the file is of sqlite type</span>
    <span class="c1"># (other file types will be handled remotely in cloud)</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">CloudPath</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">path</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span>
        <span class="ow">and</span> <span class="n">path</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;.sqlite&quot;</span><span class="p">,</span> <span class="s2">&quot;.npz&quot;</span><span class="p">]</span>
    <span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># update the path to be the local filepath for reference in CytoTable ops</span>
            <span class="c1"># note: incurs a data read which will trigger caching of the file</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">fspath</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">InvalidPrefixError</span><span class="p">:</span>
            <span class="c1"># share information about not finding a cloud path</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Did not detect a cloud path based on prefix. Defaulting to use local path operations.&quot;</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">path</span></div>



<div class="viewcode-block" id="_arrow_type_cast_if_specified">
<a class="viewcode-back" href="../../python-api.html#cytotable.utils._arrow_type_cast_if_specified">[docs]</a>
<span class="k">def</span> <span class="nf">_arrow_type_cast_if_specified</span><span class="p">(</span>
    <span class="n">column</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">data_type_cast_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Attempts to cast data types for an PyArrow field using provided a data_type_cast_map.</span>

<span class="sd">    Args:</span>
<span class="sd">        column: Dict[str, str]:</span>
<span class="sd">            Dictionary which includes a column idx, name, and dtype</span>
<span class="sd">        data_type_cast_map: Dict[str, str]</span>
<span class="sd">            A dictionary mapping data type groups to specific types.</span>
<span class="sd">            Roughly includes Arrow data types language from:</span>
<span class="sd">            https://arrow.apache.org/docs/python/api/datatypes.html</span>
<span class="sd">            Example: {&quot;float&quot;: &quot;float32&quot;}</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dict[str, str]</span>
<span class="sd">            A potentially data type updated dictionary of column information</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">cytotable.constants</span> <span class="kn">import</span> <span class="n">DDB_DATA_TYPE_SYNONYMS</span>

    <span class="c1"># for casting to new float type</span>
    <span class="k">if</span> <span class="s2">&quot;float&quot;</span> <span class="ow">in</span> <span class="n">data_type_cast_map</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">column</span><span class="p">[</span><span class="s2">&quot;column_dtype&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="s2">&quot;REAL&quot;</span><span class="p">,</span>
        <span class="s2">&quot;DOUBLE&quot;</span><span class="p">,</span>
    <span class="p">]:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;column_id&quot;</span><span class="p">:</span> <span class="n">column</span><span class="p">[</span><span class="s2">&quot;column_id&quot;</span><span class="p">],</span>
            <span class="s2">&quot;column_name&quot;</span><span class="p">:</span> <span class="n">column</span><span class="p">[</span><span class="s2">&quot;column_name&quot;</span><span class="p">],</span>
            <span class="s2">&quot;column_dtype&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">key</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">DDB_DATA_TYPE_SYNONYMS</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">data_type_cast_map</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">value</span>
            <span class="p">][</span><span class="mi">0</span><span class="p">],</span>
        <span class="p">}</span>

    <span class="c1"># for casting to new int type</span>
    <span class="k">elif</span> <span class="s2">&quot;integer&quot;</span> <span class="ow">in</span> <span class="n">data_type_cast_map</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">column</span><span class="p">[</span><span class="s2">&quot;column_dtype&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="s2">&quot;TINYINT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SMALLINT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BIGINT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;HUGEINT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;UTINYINT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;USMALLINT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;UINTEGER&quot;</span><span class="p">,</span>
        <span class="s2">&quot;UBIGINT&quot;</span><span class="p">,</span>
    <span class="p">]:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;column_id&quot;</span><span class="p">:</span> <span class="n">column</span><span class="p">[</span><span class="s2">&quot;column_id&quot;</span><span class="p">],</span>
            <span class="s2">&quot;column_name&quot;</span><span class="p">:</span> <span class="n">column</span><span class="p">[</span><span class="s2">&quot;column_name&quot;</span><span class="p">],</span>
            <span class="s2">&quot;column_dtype&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">key</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">DDB_DATA_TYPE_SYNONYMS</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">data_type_cast_map</span><span class="p">[</span><span class="s2">&quot;integer&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">value</span>
            <span class="p">][</span><span class="mi">0</span><span class="p">],</span>
        <span class="p">}</span>

    <span class="c1"># else we retain the existing data field type</span>
    <span class="k">return</span> <span class="n">column</span></div>



<div class="viewcode-block" id="_expand_path">
<a class="viewcode-back" href="../../python-api.html#cytotable.utils._expand_path">[docs]</a>
<span class="k">def</span> <span class="nf">_expand_path</span><span class="p">(</span>
    <span class="n">path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span> <span class="n">AnyPath</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span> <span class="n">AnyPath</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Expands &quot;~&quot; user directory references with the user&#39;s home directory, and expands variable references with values from the environment. After user/variable expansion, the path is resolved and an absolute path is returned.</span>

<span class="sd">    Args:</span>
<span class="sd">        path: Union[str, pathlib.Path, CloudPath]:</span>
<span class="sd">            Path to expand.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Union[pathlib.Path, Any]</span>
<span class="sd">            A local pathlib.Path or Cloudpathlib.AnyPath type path.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">os</span>
    <span class="kn">import</span> <span class="nn">pathlib</span>

    <span class="kn">from</span> <span class="nn">cloudpathlib</span> <span class="kn">import</span> <span class="n">AnyPath</span>

    <span class="c1"># expand environment variables and resolve the path as absolute</span>
    <span class="n">modifed_path</span> <span class="o">=</span> <span class="n">AnyPath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>

    <span class="c1"># note: we use pathlib.Path here to help expand local paths (~, etc)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">modifed_path</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">):</span>
        <span class="n">modifed_path</span> <span class="o">=</span> <span class="n">modifed_path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">modifed_path</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span></div>



<div class="viewcode-block" id="_get_cytotable_version">
<a class="viewcode-back" href="../../python-api.html#cytotable.utils._get_cytotable_version">[docs]</a>
<span class="k">def</span> <span class="nf">_get_cytotable_version</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Seeks the current version of CytoTable using either pkg_resources</span>
<span class="sd">    or dunamai to determine the current version being used.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str</span>
<span class="sd">            A string representing the version of CytoTable currently being used.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># attempt to gather the development version from dunamai</span>
        <span class="c1"># for scenarios where cytotable from source is used.</span>
        <span class="kn">import</span> <span class="nn">dunamai</span>

        <span class="k">return</span> <span class="n">dunamai</span><span class="o">.</span><span class="n">Version</span><span class="o">.</span><span class="n">from_any_vcs</span><span class="p">()</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">ModuleNotFoundError</span><span class="p">):</span>
        <span class="c1"># else grab a static version from __init__.py</span>
        <span class="c1"># for scenarios where the built/packaged cytotable is used.</span>
        <span class="kn">import</span> <span class="nn">cytotable</span>

        <span class="k">return</span> <span class="n">cytotable</span><span class="o">.</span><span class="n">__version__</span></div>



<div class="viewcode-block" id="_write_parquet_table_with_metadata">
<a class="viewcode-back" href="../../python-api.html#cytotable.utils._write_parquet_table_with_metadata">[docs]</a>
<span class="k">def</span> <span class="nf">_write_parquet_table_with_metadata</span><span class="p">(</span><span class="n">table</span><span class="p">:</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds metadata to parquet output from CytoTable.</span>
<span class="sd">    Note: this mostly wraps pyarrow.parquet.write_table</span>
<span class="sd">    https://arrow.apache.org/docs/python/generated/pyarrow.parquet.write_table.html</span>

<span class="sd">    Args:</span>
<span class="sd">        table: pa.Table:</span>
<span class="sd">            Pyarrow table to be serialized as parquet table.</span>
<span class="sd">        **kwargs: Any:</span>
<span class="sd">            kwargs provided to this function roughly align with</span>
<span class="sd">            pyarrow.parquet.write_table. The following might be</span>
<span class="sd">            examples of what to expect here:</span>
<span class="sd">            - where: str or pyarrow.NativeFile</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">pyarrow</span> <span class="kn">import</span> <span class="n">parquet</span>

    <span class="kn">from</span> <span class="nn">cytotable.constants</span> <span class="kn">import</span> <span class="n">CYTOTABLE_DEFAULT_PARQUET_METADATA</span>
    <span class="kn">from</span> <span class="nn">cytotable.utils</span> <span class="kn">import</span> <span class="n">_get_cytotable_version</span>

    <span class="n">parquet</span><span class="o">.</span><span class="n">write_table</span><span class="p">(</span>
        <span class="n">table</span><span class="o">=</span><span class="n">table</span><span class="o">.</span><span class="n">replace_schema_metadata</span><span class="p">(</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">CYTOTABLE_DEFAULT_PARQUET_METADATA</span>
        <span class="p">),</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="_gather_tablenumber_checksum">
<a class="viewcode-back" href="../../python-api.html#cytotable.utils._gather_tablenumber_checksum">[docs]</a>
<span class="k">def</span> <span class="nf">_gather_tablenumber_checksum</span><span class="p">(</span><span class="n">pathname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1048576</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build and return a checksum for use as a unique identifier across datasets</span>
<span class="sd">    referenced from cytominer-database:</span>
<span class="sd">    https://github.com/cytomining/cytominer-database/blob/master/cytominer_database/ingest_variable_engine.py#L129</span>

<span class="sd">    Args:</span>
<span class="sd">        pathname: str:</span>
<span class="sd">            A path to a file with which to generate the checksum on.</span>
<span class="sd">        buffer_size: int:</span>
<span class="sd">            Buffer size to use for reading data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        int</span>
<span class="sd">            an integer representing the checksum of the pathname file.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">os</span>
    <span class="kn">import</span> <span class="nn">zlib</span>

    <span class="c1"># check whether the buffer size is larger than the file_size</span>
    <span class="n">file_size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">pathname</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">file_size</span> <span class="o">&lt;</span> <span class="n">buffer_size</span><span class="p">:</span>
        <span class="n">buffer_size</span> <span class="o">=</span> <span class="n">file_size</span>

    <span class="c1"># open file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pathname</span><span class="p">),</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
        <span class="c1"># begin result formation</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">crc32</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># read data from stream using buffer size</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">buffer_size</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">buffer</span><span class="p">:</span>
                <span class="c1"># if we have no more data to use, break while loop</span>
                <span class="k">break</span>
            <span class="c1"># use buffer read data to form checksum</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">crc32</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span></div>



<div class="viewcode-block" id="_unwrap_value">
<a class="viewcode-back" href="../../python-api.html#cytotable.utils._unwrap_value">[docs]</a>
<span class="k">def</span> <span class="nf">_unwrap_value</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">parsl</span><span class="o">.</span><span class="n">dataflow</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">AppFuture</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function to unwrap futures from values or return values</span>
<span class="sd">    where there are no futures.</span>

<span class="sd">    Args:</span>
<span class="sd">        val: Union[parsl.dataflow.futures.AppFuture, Any]</span>
<span class="sd">            A value which may or may not be a Parsl future which</span>
<span class="sd">            needs to be evaluated.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Any</span>
<span class="sd">            Returns the value as-is if there&#39;s no future, the future</span>
<span class="sd">            result if Parsl futures are encountered.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># if we have a future value, evaluate the result</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">parsl</span><span class="o">.</span><span class="n">dataflow</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">AppFuture</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">val</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="c1"># if we have a list of futures, return the results</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">parsl</span><span class="o">.</span><span class="n">dataflow</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">AppFuture</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">elem</span><span class="o">.</span><span class="n">result</span><span class="p">()</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">val</span><span class="p">]</span>
    <span class="c1"># otherwise return the value</span>
    <span class="k">return</span> <span class="n">val</span></div>



<div class="viewcode-block" id="_unwrap_source">
<a class="viewcode-back" href="../../python-api.html#cytotable.utils._unwrap_source">[docs]</a>
<span class="k">def</span> <span class="nf">_unwrap_source</span><span class="p">(</span>
    <span class="n">source</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
        <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">parsl</span><span class="o">.</span><span class="n">dataflow</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">AppFuture</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">Union</span><span class="p">[</span><span class="n">parsl</span><span class="o">.</span><span class="n">dataflow</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">AppFuture</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function to unwrap futures from sources.</span>

<span class="sd">    Args:</span>
<span class="sd">        source: Union[</span>
<span class="sd">            Dict[str, Union[parsl.dataflow.futures.AppFuture, Any]],</span>
<span class="sd">            Union[parsl.dataflow.futures.AppFuture, Any],</span>
<span class="sd">        ]</span>
<span class="sd">            A source is a portion of an internal data structure used by</span>
<span class="sd">            CytoTable for processing and organizing data results.</span>
<span class="sd">    Returns:</span>
<span class="sd">        Union[Dict[str, Any], Any]</span>
<span class="sd">            An evaluated dictionary or other value type.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># if we have a dictionary, unwrap any values which may be futures</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">_unwrap_value</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">source</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># otherwise try to unwrap the source as-is without dictionary nesting</span>
        <span class="k">return</span> <span class="n">_unwrap_value</span><span class="p">(</span><span class="n">source</span><span class="p">)</span></div>



<div class="viewcode-block" id="evaluate_futures">
<a class="viewcode-back" href="../../python-api.html#cytotable.utils.evaluate_futures">[docs]</a>
<span class="k">def</span> <span class="nf">evaluate_futures</span><span class="p">(</span>
    <span class="n">sources</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]],</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="nb">str</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluates any Parsl futures for use within other tasks.</span>
<span class="sd">    This enables a pattern of Parsl app usage as &quot;tasks&quot; and delayed</span>
<span class="sd">    future result evaluation for concurrency.</span>

<span class="sd">    Args:</span>
<span class="sd">        sources: Union[Dict[str, List[Dict[str, Any]]], List[Any], str]</span>
<span class="sd">            Sources are an internal data structure used by CytoTable for</span>
<span class="sd">            processing and organizing data results. They may include futures</span>
<span class="sd">            which require asynchronous processing through Parsl, so we</span>
<span class="sd">            process them through this function.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Union[Dict[str, List[Dict[str, Any]]], str]</span>
<span class="sd">            A data structure which includes evaluated futures where they were found.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="p">{</span>
            <span class="n">source_group_name</span><span class="p">:</span> <span class="p">[</span>
                <span class="c1"># unwrap sources into future results</span>
                <span class="n">_unwrap_source</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="p">(</span>
                    <span class="n">source_group_vals</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                    <span class="c1"># if we have a future, return the result</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source_group_vals</span><span class="p">,</span> <span class="n">parsl</span><span class="o">.</span><span class="n">dataflow</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">AppFuture</span><span class="p">)</span>
                    <span class="c1"># otherwise return the value</span>
                    <span class="k">else</span> <span class="n">source_group_vals</span>
                <span class="p">)</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">source_group_name</span><span class="p">,</span> <span class="n">source_group_vals</span> <span class="ow">in</span> <span class="n">sources</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="c1"># if we have a dict, use the above, otherwise unwrap the value in case of future</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="k">else</span> <span class="n">_unwrap_value</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="_generate_pagesets">
<a class="viewcode-back" href="../../python-api.html#cytotable.utils._generate_pagesets">[docs]</a>
<span class="k">def</span> <span class="nf">_generate_pagesets</span><span class="p">(</span>
    <span class="n">keys</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="n">chunk_size</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a pageset (keyset pagination) from a list of keys.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        keys List[Union[int, float]]:</span>
<span class="sd">            List of keys to paginate.</span>
<span class="sd">        chunk_size int:</span>
<span class="sd">            Size of each chunk/page.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List[Tuple[Union[int, float], Union[int, float]]]:</span>
<span class="sd">            List of (start_key, end_key) tuples representing each page.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Initialize an empty list to store the chunks/pages</span>
    <span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Start index for iteration through the keys</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>
        <span class="c1"># Get the start key for the current chunk</span>
        <span class="n">start_key</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># Calculate the end index for the current chunk</span>
        <span class="n">end_index</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">chunk_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="c1"># Get the end key for the current chunk</span>
        <span class="n">end_key</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">end_index</span><span class="p">]</span>

        <span class="c1"># Ensure non-overlapping by incrementing the start of the next range if there are duplicates</span>
        <span class="k">while</span> <span class="n">end_index</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="ow">and</span> <span class="n">keys</span><span class="p">[</span><span class="n">end_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">end_key</span><span class="p">:</span>
            <span class="n">end_index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Append the current chunk (start_key, end_key) to the list of chunks</span>
        <span class="n">chunks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">start_key</span><span class="p">,</span> <span class="n">end_key</span><span class="p">))</span>

        <span class="c1"># Update the index to start from the next chunk</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">end_index</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c1"># Return the list of chunks/pages</span>
    <span class="k">return</span> <span class="n">chunks</span></div>



<div class="viewcode-block" id="_natural_sort">
<a class="viewcode-back" href="../../python-api.html#cytotable.utils._natural_sort">[docs]</a>
<span class="k">def</span> <span class="nf">_natural_sort</span><span class="p">(</span><span class="n">list_to_sort</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sorts the given iterable using natural sort adapted from approach</span>
<span class="sd">    provided by the following link:</span>
<span class="sd">    https://stackoverflow.com/a/4836734</span>

<span class="sd">    Args:</span>
<span class="sd">      list_to_sort: List:</span>
<span class="sd">        The list to sort.</span>

<span class="sd">    Returns:</span>
<span class="sd">      List: The sorted list.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">re</span>

    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span>
        <span class="n">list_to_sort</span><span class="p">,</span>
        <span class="c1"># use a custom key to sort the list</span>
        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">key</span><span class="p">:</span> <span class="p">[</span>
            <span class="c1"># use integer of c if it&#39;s a digit, otherwise str</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="k">else</span> <span class="n">c</span>
            <span class="c1"># Split the key into parts, separating numbers from alphabetic characters</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;([0-9]+)&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="p">],</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="_extract_npz_to_parquet">
<a class="viewcode-back" href="../../python-api.html#cytotable.utils._extract_npz_to_parquet">[docs]</a>
<span class="k">def</span> <span class="nf">_extract_npz_to_parquet</span><span class="p">(</span>
    <span class="n">source_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">dest_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">tablenumber</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract data from an .npz file created by DeepProfiler</span>
<span class="sd">    as a tabular dataset and write to parquet.</span>

<span class="sd">    DeepProfiler creates datasets which look somewhat like this:</span>
<span class="sd">    Keys in the .npz file: [&#39;features&#39;, &#39;metadata&#39;, &#39;locations&#39;]</span>

<span class="sd">    Variable: features</span>
<span class="sd">    Shape: (229, 6400)</span>
<span class="sd">    Data type: float32</span>

<span class="sd">    Variable: locations</span>
<span class="sd">    Shape: (229, 2)</span>
<span class="sd">    Data type: float64</span>

<span class="sd">    Variable: metadata</span>
<span class="sd">    Shape: ()</span>
<span class="sd">    Data type: object</span>
<span class="sd">    Whole object: {</span>
<span class="sd">    &#39;Metadata_Plate&#39;: &#39;SQ00014812&#39;,</span>
<span class="sd">    &#39;Metadata_Well&#39;: &#39;A01&#39;,</span>
<span class="sd">    &#39;Metadata_Site&#39;: 1,</span>
<span class="sd">    &#39;Plate_Map_Name&#39;: &#39;C-7161-01-LM6-022&#39;,</span>
<span class="sd">    &#39;RNA&#39;: &#39;SQ00014812/r01c01f01p01-ch3sk1fk1fl1.png&#39;,</span>
<span class="sd">    &#39;ER&#39;: &#39;SQ00014812/r01c01f01p01-ch2sk1fk1fl1.png&#39;,</span>
<span class="sd">    &#39;AGP&#39;: &#39;SQ00014812/r01c01f01p01-ch4sk1fk1fl1.png&#39;,</span>
<span class="sd">    &#39;Mito&#39;: &#39;SQ00014812/r01c01f01p01-ch5sk1fk1fl1.png&#39;,</span>
<span class="sd">    &#39;DNA&#39;: &#39;SQ00014812/r01c01f01p01-ch1sk1fk1fl1.png&#39;,</span>
<span class="sd">    &#39;Treatment_ID&#39;: 0,</span>
<span class="sd">    &#39;Treatment_Replicate&#39;: 1,</span>
<span class="sd">    &#39;Treatment&#39;: &#39;DMSO@NA&#39;,</span>
<span class="sd">    &#39;Compound&#39;: &#39;DMSO&#39;,</span>
<span class="sd">    &#39;Concentration&#39;: &#39;&#39;,</span>
<span class="sd">    &#39;Split&#39;: &#39;Training&#39;,</span>
<span class="sd">    &#39;Metadata_Model&#39;: &#39;efficientnet&#39;</span>
<span class="sd">    }</span>

<span class="sd">    Args:</span>
<span class="sd">        source_path: str</span>
<span class="sd">            Path to the .npz file.</span>
<span class="sd">        dest_path: str</span>
<span class="sd">            Destination path for the parquet file.</span>
<span class="sd">        tablenumber: Optional[int]</span>
<span class="sd">            Optional tablenumber to be added to the data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str</span>
<span class="sd">            Path to the exported parquet file.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">pathlib</span>

    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">pyarrow</span> <span class="k">as</span> <span class="nn">pa</span>
    <span class="kn">import</span> <span class="nn">pyarrow.parquet</span> <span class="k">as</span> <span class="nn">parquet</span>

    <span class="c1"># Load features from the .npz file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">loaded_npz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># find the shape of the features, which will help structure</span>
        <span class="c1"># data which doesn&#39;t yet conform to the same shape (by row count).</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">loaded_npz</span><span class="p">[</span><span class="s2">&quot;features&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># note: we use [()] to load the numpy array as a python dict</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">loaded_npz</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][()]</span>
        <span class="c1"># fetch the metadata model name, falling back to &quot;DP&quot; if not found</span>
        <span class="n">feature_prefix</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Metadata_Model&quot;</span><span class="p">,</span> <span class="s2">&quot;DP&quot;</span><span class="p">)</span>
        <span class="c1"># we transpose the feature data for more efficient</span>
        <span class="c1"># columnar-focused access</span>
        <span class="n">feature_data</span> <span class="o">=</span> <span class="n">loaded_npz</span><span class="p">[</span><span class="s2">&quot;features&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>

        <span class="n">npz_as_pydict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># add metadata to the table</span>
            <span class="c1"># note: metadata within npz files corresponds to a dictionary of</span>
            <span class="c1"># various keys and values related to the feature and location data.</span>
            <span class="s2">&quot;Metadata_TableNumber&quot;</span><span class="p">:</span> <span class="n">pa</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tablenumber</span><span class="p">]</span> <span class="o">*</span> <span class="n">rows</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">pa</span><span class="o">.</span><span class="n">int64</span><span class="p">()),</span>
            <span class="s2">&quot;Metadata_NPZSource&quot;</span><span class="p">:</span> <span class="n">pa</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">source_path</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">*</span> <span class="n">rows</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">pa</span><span class="o">.</span><span class="n">string</span><span class="p">()</span>
            <span class="p">),</span>
            <span class="o">**</span><span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="p">[</span><span class="n">metadata</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="o">*</span> <span class="n">rows</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">keys</span><span class="p">()},</span>
            <span class="c1"># add locations data to the table</span>
            <span class="s2">&quot;Location_Center_X&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">loaded_npz</span><span class="p">[</span><span class="s2">&quot;locations&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rows</span><span class="p">)],</span>
            <span class="s2">&quot;Location_Center_Y&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">loaded_npz</span><span class="p">[</span><span class="s2">&quot;locations&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rows</span><span class="p">)],</span>
            <span class="c1"># add features data to the table</span>
            <span class="o">**</span><span class="p">{</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">feature_prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">feature_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">feature_data</span><span class="p">[</span><span class="n">feature_idx</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">feature_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">feature_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="p">},</span>
        <span class="p">}</span>

    <span class="c1"># convert the numpy arrays to a PyArrow table and write to parquet</span>
    <span class="n">parquet</span><span class="o">.</span><span class="n">write_table</span><span class="p">(</span><span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="o">.</span><span class="n">from_pydict</span><span class="p">(</span><span class="n">npz_as_pydict</span><span class="p">),</span> <span class="n">dest_path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dest_path</span></div>



<div class="viewcode-block" id="map_pyarrow_type">
<a class="viewcode-back" href="../../python-api.html#cytotable.utils.map_pyarrow_type">[docs]</a>
<span class="k">def</span> <span class="nf">map_pyarrow_type</span><span class="p">(</span>
    <span class="n">field_type</span><span class="p">:</span> <span class="n">pa</span><span class="o">.</span><span class="n">DataType</span><span class="p">,</span> <span class="n">data_type_cast_map</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pa</span><span class="o">.</span><span class="n">DataType</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Map PyArrow types dynamically to handle nested types and casting.</span>

<span class="sd">    This function takes a PyArrow `field_type` and dynamically maps</span>
<span class="sd">    it to a valid PyArrow type, handling nested types (e.g., lists,</span>
<span class="sd">    structs) and resolving type conflicts (e.g., integer to float).</span>
<span class="sd">    It also supports custom type casting using the</span>
<span class="sd">    `data_type_cast_map` parameter.</span>

<span class="sd">    Args:</span>
<span class="sd">        field_type: pa.DataType</span>
<span class="sd">            The PyArrow data type to be mapped.</span>
<span class="sd">            This can include simple types (e.g., int, float, string)</span>
<span class="sd">            or nested types (e.g., list, struct).</span>
<span class="sd">        data_type_cast_map: Optional[Dict[str, str]], default None</span>
<span class="sd">            A dictionary mapping data type groups to specific types.</span>
<span class="sd">            This allows for custom type casting.</span>
<span class="sd">            For example:</span>
<span class="sd">            - {&quot;float&quot;: &quot;float32&quot;} maps</span>
<span class="sd">            floating-point types to `float32`.</span>
<span class="sd">            - {&quot;int&quot;: &quot;int64&quot;} maps integer</span>
<span class="sd">            types to `int64`.</span>
<span class="sd">            If `data_type_cast_map` is</span>
<span class="sd">            None, default PyArrow types are used.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pa.DataType</span>
<span class="sd">            The mapped PyArrow data type.</span>
<span class="sd">            If no mapping is needed, the original</span>
<span class="sd">            `field_type` is returned.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">pa</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_list</span><span class="p">(</span><span class="n">field_type</span><span class="p">):</span>
        <span class="c1"># Handle list types (e.g., list&lt;element: float&gt;)</span>
        <span class="k">return</span> <span class="n">pa</span><span class="o">.</span><span class="n">list_</span><span class="p">(</span>
            <span class="n">map_pyarrow_type</span><span class="p">(</span>
                <span class="n">field_type</span><span class="o">=</span><span class="n">field_type</span><span class="o">.</span><span class="n">value_type</span><span class="p">,</span> <span class="n">data_type_cast_map</span><span class="o">=</span><span class="n">data_type_cast_map</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">pa</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_struct</span><span class="p">(</span><span class="n">field_type</span><span class="p">):</span>
        <span class="c1"># Handle struct types recursively</span>
        <span class="k">return</span> <span class="n">pa</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">(</span>
                    <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">map_pyarrow_type</span><span class="p">(</span>
                        <span class="n">field_type</span><span class="o">=</span><span class="n">field</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">data_type_cast_map</span><span class="o">=</span><span class="n">data_type_cast_map</span>
                    <span class="p">),</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">field_type</span>
            <span class="p">]</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">pa</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_floating</span><span class="p">(</span><span class="n">field_type</span><span class="p">):</span>
        <span class="c1"># Handle floating-point types</span>
        <span class="k">if</span> <span class="n">data_type_cast_map</span> <span class="ow">and</span> <span class="s2">&quot;float&quot;</span> <span class="ow">in</span> <span class="n">data_type_cast_map</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pa</span><span class="o">.</span><span class="n">type_for_alias</span><span class="p">(</span><span class="n">data_type_cast_map</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">pa</span><span class="o">.</span><span class="n">float64</span><span class="p">()</span>  <span class="c1"># Default to float64 if no mapping is provided</span>
    <span class="k">elif</span> <span class="n">pa</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_integer</span><span class="p">(</span><span class="n">field_type</span><span class="p">):</span>
        <span class="c1"># Handle integer types</span>
        <span class="k">if</span> <span class="n">data_type_cast_map</span> <span class="ow">and</span> <span class="s2">&quot;integer&quot;</span> <span class="ow">in</span> <span class="n">data_type_cast_map</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pa</span><span class="o">.</span><span class="n">type_for_alias</span><span class="p">(</span><span class="n">data_type_cast_map</span><span class="p">[</span><span class="s2">&quot;integer&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">pa</span><span class="o">.</span><span class="n">int64</span><span class="p">()</span>  <span class="c1"># Default to int64 if no mapping is provided</span>
    <span class="k">elif</span> <span class="n">pa</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_string</span><span class="p">(</span><span class="n">field_type</span><span class="p">):</span>
        <span class="c1"># Handle string types</span>
        <span class="k">return</span> <span class="n">pa</span><span class="o">.</span><span class="n">string</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">pa</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_null</span><span class="p">(</span><span class="n">field_type</span><span class="p">):</span>
        <span class="c1"># Handle null types</span>
        <span class="k">return</span> <span class="n">pa</span><span class="o">.</span><span class="n">null</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Default to the original type if no mapping is needed</span>
        <span class="k">return</span> <span class="n">field_type</span></div>



<div class="viewcode-block" id="find_anndata_metadata_field_names">
<a class="viewcode-back" href="../../python-api.html#cytotable.utils.find_anndata_metadata_field_names">[docs]</a>
<span class="k">def</span> <span class="nf">find_anndata_metadata_field_names</span><span class="p">(</span>
    <span class="n">source</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Classify the source table columns as</span>
<span class="sd">    numeric and non-numeric.</span>

<span class="sd">    Scans the Parquet file schema</span>
<span class="sd">    and returns two lists of column names:</span>
<span class="sd">    those with numeric types (float, integer, decimal)</span>
<span class="sd">    and those with any other type. This is handy for</span>
<span class="sd">    separating AnnData metadata fields by basic</span>
<span class="sd">    numeric-ness for downstream processing.</span>

<span class="sd">    Args:</span>
<span class="sd">        source:</span>
<span class="sd">            Path to a Parquet file to inspect.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A 2-tuple ``(numeric_fields, non_numeric_fields)``,</span>
<span class="sd">        where each element is</span>
<span class="sd">        a list of column names.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">pyarrow.parquet</span> <span class="k">as</span> <span class="nn">parquet</span>

    <span class="c1"># read the schema from the parquet file</span>
    <span class="n">schema</span> <span class="o">=</span> <span class="n">parquet</span><span class="o">.</span><span class="n">read_schema</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">source</span><span class="p">))</span>

    <span class="c1"># gather numeric fields based on PyArrow types</span>
    <span class="n">numeric_fields</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">field</span><span class="o">.</span><span class="n">name</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">schema</span>
        <span class="k">if</span> <span class="n">pa</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_floating</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
        <span class="ow">or</span> <span class="n">pa</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_integer</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
        <span class="ow">or</span> <span class="n">pa</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_decimal</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="c1"># gather everything else as non-numeric</span>
    <span class="n">non_numeric_fields</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">schema</span> <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">numeric_fields</span>
    <span class="p">]</span>

    <span class="k">return</span> <span class="n">numeric_fields</span><span class="p">,</span> <span class="n">non_numeric_fields</span></div>



<div class="viewcode-block" id="cloud_glob">
<a class="viewcode-back" href="../../python-api.html#cytotable.utils.cloud_glob">[docs]</a>
<span class="k">def</span> <span class="nf">cloud_glob</span><span class="p">(</span>
    <span class="n">start</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">CloudPath</span><span class="p">,</span> <span class="n">Path</span><span class="p">],</span>
    <span class="n">pattern</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">max_matches</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cp_client</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">S3Client</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">boto_s3_client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">CloudPath</span><span class="p">,</span> <span class="n">Path</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Globs under `start` and yields matching paths.</span>
<span class="sd">    We provide cloud-platform specific optimizations</span>
<span class="sd">    as needed based on platform SDK&#39;s.</span>

<span class="sd">    Behavior by input type:</span>
<span class="sd">      - S3 (cloudpathlib S3Path or &#39;s3://...&#39;):</span>
<span class="sd">          Use unsigned boto3 to list keys and yield unsigned cloudpathlib.S3Path.</span>
<span class="sd">      - Other CloudPath (e.g., GCS/Azure/local providers via cloudpathlib):</span>
<span class="sd">          Fallback to CloudPath.glob(pattern), yielding CloudPath.</span>
<span class="sd">      - Local filesystem (pathlib.Path or non-s3 string):</span>
<span class="sd">          Fallback to Path.glob(pattern), yielding pathlib.Path.</span>

<span class="sd">    Args:</span>
<span class="sd">        start:</span>
<span class="sd">            CloudPath, pathlib.Path, or URI string.</span>
<span class="sd">        pattern:</span>
<span class="sd">            Glob pattern *relative to* `start` (supports ** for S3 branch).</span>
<span class="sd">        max_matches:</span>
<span class="sd">            Optional cap on yielded results.</span>
<span class="sd">        cp_client:</span>
<span class="sd">            cloudpathlib S3Client (unsigned recommended).</span>
<span class="sd">        boto_s3_client:</span>
<span class="sd">            boto3 S3 client (unsigned recommended).</span>

<span class="sd">    Yields:</span>
<span class="sd">        cloudpathlib.S3Path for S3;</span>
<span class="sd">        CloudPath for other cloud providers;</span>
<span class="sd">        pathlib.Path for local.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_ensure_trailing_slash</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">s</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">s</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>

    <span class="k">def</span> <span class="nf">_matches</span><span class="p">(</span><span class="n">rel</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pat</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pathlib semantics: &#39;**/*.csv&#39; does NOT match &#39;file.csv&#39;.</span>
<span class="sd">        If pattern starts with &#39;**/&#39;, also try the root-level variant(s).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">PurePosixPath</span><span class="p">(</span><span class="n">rel</span><span class="p">)</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pat</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="c1"># if pattern starts with one or more &#39;**/&#39;, progressively strip them</span>
        <span class="c1"># so &#39;**/*.csv&#39; also tries &#39;*.csv&#39;, etc.</span>
        <span class="k">while</span> <span class="n">pat</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;**/&quot;</span><span class="p">):</span>
            <span class="n">pat</span> <span class="o">=</span> <span class="n">pat</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
            <span class="k">if</span> <span class="n">PurePosixPath</span><span class="p">(</span><span class="n">rel</span><span class="p">)</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pat</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># ---- Branch 1: already a CloudPath ----</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">CloudPath</span><span class="p">):</span>
        <span class="n">cp</span> <span class="o">=</span> <span class="n">start</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">S3Path</span><span class="p">):</span>
            <span class="n">s3cli</span> <span class="o">=</span> <span class="n">boto_s3_client</span> <span class="ow">or</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span>
                <span class="s2">&quot;s3&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">BotoConfig</span><span class="p">(</span><span class="n">signature_version</span><span class="o">=</span><span class="n">UNSIGNED</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">s3_cp_client</span> <span class="o">=</span> <span class="n">cp_client</span> <span class="ow">or</span> <span class="n">S3Client</span><span class="p">(</span><span class="n">no_sign_request</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">bucket</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">bucket</span>
            <span class="n">base_prefix</span> <span class="o">=</span> <span class="n">_ensure_trailing_slash</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>

            <span class="n">paginator</span> <span class="o">=</span> <span class="n">s3cli</span><span class="o">.</span><span class="n">get_paginator</span><span class="p">(</span><span class="s2">&quot;list_objects_v2&quot;</span><span class="p">)</span>
            <span class="n">yielded</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">paginator</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">Prefix</span><span class="o">=</span><span class="n">base_prefix</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">page</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Contents&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;Key&quot;</span><span class="p">]</span>
                    <span class="n">rel</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">key</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">base_prefix</span><span class="p">)</span> <span class="p">:]</span> <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">base_prefix</span><span class="p">)</span> <span class="k">else</span> <span class="n">key</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">_matches</span><span class="p">(</span><span class="n">rel</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
                        <span class="k">yield</span> <span class="n">S3Path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s3://</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="n">s3_cp_client</span><span class="p">)</span>
                        <span class="n">yielded</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">max_matches</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">yielded</span> <span class="o">&gt;=</span> <span class="n">max_matches</span><span class="p">:</span>
                            <span class="k">return</span>
            <span class="k">return</span>

        <span class="c1"># Non-S3 CloudPath fallback</span>
        <span class="n">yielded</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">cp</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">pattern</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">child</span>
            <span class="n">yielded</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">max_matches</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">yielded</span> <span class="o">&gt;=</span> <span class="n">max_matches</span><span class="p">:</span>
                <span class="k">return</span>
        <span class="k">return</span>

    <span class="c1"># ---- Branch 2: local Path ----</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
        <span class="n">yielded</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">start</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">pattern</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">child</span>
            <span class="n">yielded</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">max_matches</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">yielded</span> <span class="o">&gt;=</span> <span class="n">max_matches</span><span class="p">:</span>
                <span class="k">return</span>
        <span class="k">return</span>

    <span class="c1"># ---- Branch 3: string path ----</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">start</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;s3://&quot;</span><span class="p">):</span>
            <span class="n">s3_cp_client</span> <span class="o">=</span> <span class="n">cp_client</span> <span class="ow">or</span> <span class="n">S3Client</span><span class="p">(</span><span class="n">no_sign_request</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">cp_root</span> <span class="o">=</span> <span class="n">s3_cp_client</span><span class="o">.</span><span class="n">CloudPath</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
            <span class="c1"># re-enter CloudPath branch</span>
            <span class="k">yield from</span> <span class="n">cloud_glob</span><span class="p">(</span>
                <span class="n">cp_root</span><span class="p">,</span>
                <span class="n">pattern</span><span class="p">,</span>
                <span class="n">max_matches</span><span class="o">=</span><span class="n">max_matches</span><span class="p">,</span>
                <span class="n">cp_client</span><span class="o">=</span><span class="n">s3_cp_client</span><span class="p">,</span>
                <span class="n">boto_s3_client</span><span class="o">=</span><span class="n">boto_s3_client</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
            <span class="n">yielded</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">base</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">pattern</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">child</span>
                <span class="n">yielded</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">max_matches</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">yielded</span> <span class="o">&gt;=</span> <span class="n">max_matches</span><span class="p">:</span>
                    <span class="k">return</span>
            <span class="k">return</span>

    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported path type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">start</span><span class="p">)</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span></div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">CytoTable</a></h1>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=cytomining&repo=CytoTable&type=star&count=false&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentations.html">Presentations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code_of_conduct.html">Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../architecture.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python-api.html">Python API</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2022, Cytomining Community.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.1.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>